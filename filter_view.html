<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Filter View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvc9C5PuDqrI26jrmsg5b1PVOW6_k43W4",
            authDomain: "mbti-kale.firebaseapp.com",
            databaseURL: "https://mbti-kale-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mbti-kale",
            storageBucket: "mbti-kale.firebasestorage.app",
            messagingSenderId: "756176954275",
            appId: "1:756176954275:web:7581e5e485e426b33ff016",
            measurementId: "G-B6F0F4JZ7E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("name");
        const filterType = urlParams.get("filter") || "relationshipType";
        const MyMBTI = urlParams.get("mbti") || "ENFP";

        let allData = [];

        document.addEventListener('DOMContentLoaded', async function() {
            // Update the MBTI title with the user's MBTI type from URL
            const mbtiParts = MyMBTI.split('');
            document.getElementById("mbti-title").innerHTML = `Your MBTI Type: <span class="mbti-highlight">${mbtiParts.join('')}</span>`;
            
            await fetchData();
            processData();
        });

        async function fetchData() {
            try {
                const dbRef = ref(database, "responses");
                const q = query(dbRef, orderByChild("username"), equalTo(username));
                const snapshot = await get(q);
                allData = [];

                if (!snapshot.exists()) {
                    console.log("No data found for this username");
                    document.querySelector(".summary-title").innerHTML = "No data found for this username";
                    return;
                }
                
                snapshot.forEach(child => {
                    const d = child.val();
                    if (d.ie && d.ns && d.ft && d.jp) {
                        // Directly create MBTI type from the string values
                        const mbtiType = d.ie + d.ns + d.ft + d.jp;
                        
                        // Convert string values to numerical for charts
                        const ieVal = d.ie === "I" ? -1 : 1;
                        const nsVal = d.ns === "N" ? -1 : 1;
                        const ftVal = d.ft === "F" ? -1 : 1;
                        const jpVal = d.jp === "J" ? -1 : 1;
                        
                        allData.push({
                            email: d.email,
                            ie: ieVal,
                            ns: nsVal,
                            ft: ftVal,
                            jp: jpVal,
                            ieStr: d.ie,
                            nsStr: d.ns,
                            ftStr: d.ft,
                            jpStr: d.jp,
                            mbtiType: mbtiType,
                            familiarity: parseInt(d.intimacyGraphReverse) || 1,
                            intimacy: parseInt(d.intimacyGraph) || 1,
                            relationshipType: d.relationshipType || "Unknown",
                            sinceWhen: d.sinceWhen || "Unknown",
                            interactionPlace: d.interactionPlace || "Unknown",
                            filterValue: d[filterType] || "Unknown"
                        });
                        
                        console.log("Processed data entry:", mbtiType, ieVal, nsVal, ftVal, jpVal);
                    }
                });
                
                console.log("Fetched data:", allData);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.querySelector(".summary-title").innerHTML = "Error fetching data: " + error.message;
            }
        }

        // This function is no longer needed as we're using the string values directly
        // Keeping it here in case we need to convert numerical values to MBTI strings in the future
        function getMBTIFromTraits(ie, ns, ft, jp) {
            if (typeof ie === 'string') return ie + ns + ft + jp;
            
            return (ie < 0 ? "I" : "E") + 
                   (ns < 0 ? "N" : "S") + 
                   (ft < 0 ? "F" : "T") + 
                   (jp < 0 ? "J" : "P");
        }

        function processData() {
            if (allData.length === 0) return;
            
            // Calculate MBTI type distribution
            const mbtiCounts = {};
            allData.forEach(person => {
                const type = person.mbtiType;
                mbtiCounts[type] = (mbtiCounts[type] || 0) + 1;
            });
            
            // Calculate trait statistics
            let iCount = 0, eCount = 0, nCount = 0, sCount = 0, fCount = 0, tCount = 0, jCount = 0, pCount = 0;
            allData.forEach(person => {
                if (person.ieStr === "I") iCount++;
                if (person.ieStr === "E") eCount++;
                if (person.nsStr === "N") nCount++;
                if (person.nsStr === "S") sCount++;
                if (person.ftStr === "F") fCount++;
                if (person.ftStr === "T") tCount++;
                if (person.jpStr === "J") jCount++;
                if (person.jpStr === "P") pCount++;
            });
            
            const total = allData.length;
            const iPercent = Math.round((iCount / total) * 100);
            const ePercent = Math.round((eCount / total) * 100);
            const nPercent = Math.round((nCount / total) * 100);
            const sPercent = Math.round((sCount / total) * 100);
            const fPercent = Math.round((fCount / total) * 100);
            const tPercent = Math.round((tCount / total) * 100);
            const jPercent = Math.round((jCount / total) * 100);
            const pPercent = Math.round((pCount / total) * 100);
            
            // Find most common mistype
            const mistypes = {};
            allData.forEach(person => {
                if (person.mbtiType !== MyMBTI) {
                    mistypes[person.mbtiType] = (mistypes[person.mbtiType] || 0) + 1;
                }
            });

            let mostCommonMistype = "None";
            const entries = Object.entries(mistypes);
            if (entries.length > 0) {
                const maxValue = Math.max(...entries.map(([_, val]) => val));
                const topTypes = entries.filter(([_, val]) => val === maxValue).map(([key]) => key);
                mostCommonMistype = topTypes.length === 1 ? topTypes[0] :  topTypes.join(", ");
            }

            
            // Calculate average traits for comparison chart
            let avgIE = 0, avgNS = 0, avgFT = 0, avgJP = 0;
            allData.forEach(person => {
                avgIE += person.ie;
                avgNS += person.ns;
                avgFT += person.ft;
                avgJP += person.jp;
            });
            
            avgIE /= allData.length;
            avgNS /= allData.length;
            avgFT /= allData.length;
            avgJP /= allData.length;
            
            // Calculate perception by relationship
            const relationshipPerception = {};
            allData.forEach(person => {
                const rel = person.relationshipType;
                if (!relationshipPerception[rel]) {
                    relationshipPerception[rel] = {
                        types: {},
                        count: 0
                    };
                }
                relationshipPerception[rel].count++;
                relationshipPerception[rel].types[person.mbtiType] = 
                    (relationshipPerception[rel].types[person.mbtiType] || 0) + 1;
            });
            
            // Update UI
            updateSummary(allData.length, allData.filter(p => p.mbtiType !== MyMBTI).length, 
                          mostCommonMistype, iPercent, ePercent, nPercent, sPercent, 
                          fPercent, tPercent, jPercent, pPercent);
            
            drawMBTIVisualization(mbtiCounts);
            drawTraitComparisonChart(avgIE, avgNS, avgFT, avgJP);
            updateFilterSections();

        }

        function updateSummary(totalCount, mistypeCount, mostCommonMistype, 
                               iPercent, ePercent, nPercent, sPercent, 
                               fPercent, tPercent, jPercent, pPercent) {

            
            const summaryElem = document.querySelector(".summary-title");

            if (mistypeCount === 0) {
                summaryElem.innerHTML = `<span class="mbti-highlight">Everyone</span> perceived you as your type.`;
            } else {
                summaryElem.innerHTML = 
                    `<span class="mbti-highlight">${mistypeCount}</span> out of <span class="mbti-highlight">${totalCount}</span> people perceive you 
                    <span class="mbti-highlight">not your type</span>, 
                    the most common mistypes are <span class="mbti-highlight">${mostCommonMistype}</span>.`;
            }
            // Create the slider-like visualization for each trait pair
            const summaryList = document.querySelector(".summary-list");
            summaryList.innerHTML = `
                <li class="trait-slider">
                    <div class="trait-label">${MyMBTI[0]}</div>
                    <div class="slider-container">
                        <div class="slider-bar">
                            <div class="slider-fill" style="width: ${MyMBTI[0] === 'I' ? iPercent : ePercent}%"></div>
                        </div>
                        <div class="slider-percentages">
                            <span>${MyMBTI[0] === 'I' ? iPercent : ePercent}%</span>
                            <span>${MyMBTI[0] === 'I' ? ePercent : iPercent}%</span>
                        </div>
                    </div>
                    <div class="trait-label">${MyMBTI[0] === 'I' ? 'E' : 'I'}</div>
                </li>
                <li class="trait-slider">
                    <div class="trait-label">${MyMBTI[1]}</div>
                    <div class="slider-container">
                        <div class="slider-bar">
                            <div class="slider-fill" style="width: ${MyMBTI[1] === 'N' ? nPercent : sPercent}%"></div>
                        </div>
                        <div class="slider-percentages">
                            <span>${MyMBTI[1] === 'N' ? nPercent : sPercent}%</span>
                            <span>${MyMBTI[1] === 'N' ? sPercent : nPercent}%</span>
                        </div>
                    </div>
                    <div class="trait-label">${MyMBTI[1] === 'N' ? 'S' : 'N'}</div>
                </li>
                <li class="trait-slider">
                    <div class="trait-label">${MyMBTI[2]}</div>
                    <div class="slider-container">
                        <div class="slider-bar">
                            <div class="slider-fill" style="width: ${MyMBTI[2] === 'F' ? fPercent : tPercent}%"></div>
                        </div>
                        <div class="slider-percentages">
                            <span>${MyMBTI[2] === 'F' ? fPercent : tPercent}%</span>
                            <span>${MyMBTI[2] === 'F' ? tPercent : fPercent}%</span>
                        </div>
                    </div>
                    <div class="trait-label">${MyMBTI[2] === 'F' ? 'T' : 'F'}</div>
                </li>
                <li class="trait-slider">
                    <div class="trait-label">${MyMBTI[3]}</div>
                    <div class="slider-container">
                        <div class="slider-bar">
                            <div class="slider-fill" style="width: ${MyMBTI[3] === 'J' ? jPercent : pPercent}%"></div>
                        </div>
                        <div class="slider-percentages">
                            <span>${MyMBTI[3] === 'J' ? jPercent : pPercent}%</span>
                            <span>${MyMBTI[3] === 'J' ? pPercent : jPercent}%</span>
                        </div>
                    </div>
                    <div class="trait-label">${MyMBTI[3] === 'J' ? 'P' : 'J'}</div>
                </li>
            `;
        }

        function drawMBTIVisualization(mbtiCounts) {
            const vizContainer = document.getElementById('mbtiVisualization');
            vizContainer.innerHTML = '';

            function getDimensionDiff(base, other) {
                let diff = 0;
                for (let i = 0; i < 4; i++) {
                    if (base[i] !== other[i]) diff++;
                }
                return diff;
            }

            function getColoredMBTI(base, target) {
                let result = '';
                for (let i = 0; i < 4; i++) {
                    if (base[i] === target[i]) {
                        result += `<span>${target[i]}</span>`;
                    } else {
                        result += `<span style="color:#E9634A;">${target[i]}</span>`;
                    }
                }
                return result;
            }

            // 排序：与 MyMBTI 不同的维度数从少到多
            const sortedTypes = Object.keys(mbtiCounts).sort((a, b) => {
                return getDimensionDiff(MyMBTI, a) - getDimensionDiff(MyMBTI, b);
            });

            sortedTypes.forEach(type => {
                const typeElem = document.createElement('div');
                typeElem.className = 'mbti-type';
                if (type === MyMBTI) {
                    typeElem.classList.add('your-type');
                }

                // 内部 HTML 为每个字母，标红不同维度
                typeElem.innerHTML = getColoredMBTI(MyMBTI, type);

                // 添加数量徽章
                const count = document.createElement('span');
                count.className = 'count-badge';
                count.innerText = mbtiCounts[type];
                typeElem.appendChild(count);

                vizContainer.appendChild(typeElem);
            });

        }

        function drawTraitComparisonChart(avgIE, avgNS, avgFT, avgJP) {
            // Parse MyMBTI to get numerical values for comparison
            const myTraits = {
                IE: MyMBTI.includes('I') ? -2 : 2,  // Simplified scale for visualization
                NS: MyMBTI.includes('N') ? -2 : 2,
                FT: MyMBTI.includes('F') ? -2 : 2,
                JP: MyMBTI.includes('J') ? -2 : 2
            };
            
            // Scale the averages for better visualization
            const scaledAvgIE = avgIE * 2;  // Scale to similar range as myTraits
            const scaledAvgNS = avgNS * 2;
            const scaledAvgFT = avgFT * 2;
            const scaledAvgJP = avgJP * 2;
            
            // const ctx = document.getElementById('traitChart').getContext('2d');
            // if (window.traitChart) {
            //     window.traitChart.destroy();
            // }
            
            // window.traitChart = new Chart(ctx, {
            //     type: 'bar',
            //     data: {
            //         labels: ['I/E', 'N/S', 'F/T', 'J/P'],
            //         datasets: [
            //             {
            //                 label: 'Your Type',
            //                 data: [myTraits.IE, myTraits.NS, myTraits.FT, myTraits.JP],
            //                 backgroundColor: '#203270',
            //             },
            //             {
            //                 label: 'Others Perception',
            //                 data: [scaledAvgIE, scaledAvgNS, scaledAvgFT, scaledAvgJP],
            //                 backgroundColor: '#e995b8',
            //             }
            //         ]
            //     },
            //     options: {
            //         responsive: true,
            //         maintainAspectRatio: true,
            //         scales: {
            //             y: {
            //                 beginAtZero: false,
            //                 min: -4,
            //                 max: 4,
            //                 ticks: {
            //                     stepSize: 1,
            //                     callback: function(value) {
            //                         if (value === -4) return 'Strong I/N/F/J';
            //                         if (value === 4) return 'Strong E/S/T/P';
            //                         if (value === 0) return 'Neutral';
            //                         return '';
            //                     }
            //                 }
            //             }
            //         },
            //         plugins: {
            //             legend: {
            //                 position: 'bottom'
            //             }
            //         }
            //     }
            // });
        }

        function updateFilterSections() {
            console.log('⚙️ updateFilterSections() called');
            const filters = [
                { key: 'relationshipType', sectionId: 'relationshipTypeSection' },
                { key: 'sinceWhen',        sectionId: 'sinceWhenSection'       },
                { key: 'intimacy',    sectionId: 'intimacyGraphSection'   },
                { key: 'interactionPlace', sectionId: 'interactionPlaceSection'}
            ];

            filters.forEach(({ key, sectionId }) => {
                const ul = document.getElementById(sectionId);
                if (!ul) return console.error('UL not found:', sectionId);
                ul.innerHTML = ''; // 清空

                // 分组
                const groups = allData.reduce((acc, p) => {
                const v = p[key] || 'Unknown';
                ;(acc[v] = acc[v]||[]).push(p);
                return acc;
                }, {});

                // 输出每个分组
                Object.entries(groups).forEach(([group, list]) => {
                const total = list.length;

                // 四个维度统计
                const eCnt = list.filter(p=>p.ieStr==='E').length, iCnt = total - eCnt;
                const ieM = eCnt>=iCnt?'E':'I', iePct = Math.round(Math.max(eCnt,iCnt)/total*100);
                const nCnt = list.filter(p=>p.nsStr==='N').length, sCnt = total - nCnt;
                const nsM = nCnt>=sCnt?'N':'S', nsPct = Math.round(Math.max(nCnt,sCnt)/total*100);
                const fCnt = list.filter(p=>p.ftStr==='F').length, tCnt = total - fCnt;
                const ftM = fCnt>=tCnt?'F':'T', ftPct = Math.round(Math.max(fCnt,tCnt)/total*100);
                const jCnt = list.filter(p=>p.jpStr==='J').length, pCnt = total - jCnt;
                const jpM = jCnt>=pCnt?'J':'P', jpPct = Math.round(Math.max(jCnt,pCnt)/total*100);

                // 构造 card
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="group-name">${group}</div>
                    <div class="stats">
                    <span class="stat ie">${iePct}%${ieM}</span>
                    <span class="stat ns">${nsPct}%${nsM}</span>
                    <span class="stat ft">${ftPct}%${ftM}</span>
                    <span class="stat jp">${jpPct}%${jpM}</span>
                    </div>`;
                ul.appendChild(li);
                });
            });
            }

        // 为每个 filter 生成分组统计并填充到对应的 <ul>
        // function updateFilterSections() {
        //     console.log('⚙️ updateFilterSections() called');
        //     // 要处理的四个字段，以及它们对应的 <ul id>
        //     const filters = [
        //         { key: 'relationshipType', sectionId: 'relationshipTypeSection' },
        //         { key: 'sinceWhen',       sectionId: 'sinceWhenSection'       },
        //         { key: 'intimacy',   sectionId: 'intimacyGraphSection'   },
        //         { key: 'interactionPlace',sectionId: 'interactionPlaceSection'}
        //     ];

        //     filters.forEach(({ key, sectionId }) => {
        //         const ul = document.getElementById(sectionId);
        //         ul.innerHTML = '';  // 清空
        //         // 按字段值分组
        //         const groups = allData.reduce((acc, person) => {
        //             const val = person[key] || 'Unknown';
        //             if (!acc[val]) acc[val] = [];
        //             acc[val].push(person);
        //             return acc;
        //         }, {});

        //         // 遍历每个组，计算 IE 维度中 E 的百分比，并输出 LI
        //         Object.entries(groups).forEach(([groupValue, list]) => {
        //             const total = list.length;

        //             // IE 维度
        //             const eCount = list.filter(p => p.ieStr === 'E').length;
        //             const iCount = total - eCount;
        //             const ieMajor = eCount >= iCount ? 'E' : 'I';
        //             const iePercent = Math.round((Math.max(eCount, iCount) / total) * 100);

        //             // NS 维度
        //             const nCount = list.filter(p => p.nsStr === 'N').length;
        //             const sCount = total - nCount;
        //             const nsMajor = nCount >= sCount ? 'N' : 'S';
        //             const nsPercent = Math.round((Math.max(nCount, sCount) / total) * 100);

        //             // FT 维度
        //             const fCount = list.filter(p => p.ftStr === 'F').length;
        //             const tCount = total - fCount;
        //             const ftMajor = fCount >= tCount ? 'F' : 'T';
        //             const ftPercent = Math.round((Math.max(fCount, tCount) / total) * 100);

        //             // JP 维度
        //             const jCount = list.filter(p => p.jpStr === 'J').length;
        //             const pCount = total - jCount;
        //             const jpMajor = jCount >= pCount ? 'J' : 'P';
        //             const jpPercent = Math.round((Math.max(jCount, pCount) / total) * 100);

        //             // 构造一行文字：只放每个维度的“多数侧+百分比”
        //             const li = document.createElement('li');
        //             li.textContent = `${groupValue}：${iePercent}%${ieMajor}, ${nsPercent}%${nsMajor}, ${ftPercent}%${ftMajor}, ${jpPercent}%${jpMajor}`;
        //             ul.appendChild(li);
        //         });
        //     });
        // }

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f8fb;
            color: #333;
            margin: 0;
            padding: 30px;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .header-section {
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid #eaeaea;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        #mbti-title {
            font-size: 18px;
            color: #203270;
        }

        .summary-section {
            text-align: left;
            padding: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .summary-list {
            list-style-type: none;
            padding-left: 0;
        }

        /* Slider styles for trait visualization */
        .trait-slider {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .trait-label {
            font-weight: bold;
            width: 20px;
            text-align: center;
            color: #203270;
        }

        .slider-container {
            flex-grow: 1;
        }

        .slider-bar {
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .slider-fill {
            height: 100%;
            background-color: #203270;
            border-radius: 6px 0 0 6px;
        }

        .slider-percentages {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 2px;
            color: #666;
        }

        .visualization-section {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .chart-container {
            width: 48%;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }

        .relationship-section {
            text-align: left;
            padding: 20px;
            border-top: 1px solid #eaeaea;
        }

        .relationship-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* —— 卡片网格 —— */
        .relationship-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 24px;
        padding: 0;
        margin: 0;
        list-style: none;
        }

        /* —— 卡片样式 & 悬浮效果 —— */
        .relationship-list li {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform .2s, box-shadow .2s;
        }
        .relationship-list li:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        /* —— 分组名 —— */
        .relationship-list li .group-name {
        font-size: 16px;
        font-weight: 700;
        color: #203270;
        margin-bottom: 12px;
        text-align: center;
        }

        /* —— 徽章容器 —— */
        .relationship-list li .stats {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        }

        /* —— 徽章共用 —— */
        .relationship-list li .stat {
        padding: 6px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 16px;
        }

        /* —— 四维度专属配色 —— */
        .relationship-list li .stat.ie { background: rgba(32,50,112,0.15); color: #203270; }
        .relationship-list li .stat.ns { background: rgba(40,167,69,0.15);  color: #28a745; }
        .relationship-list li .stat.ft { background: rgba(111,66,193,0.15); color: #6f42c1; }
        .relationship-list li .stat.jp { background: rgba(253,126,20,0.15); color: #fd7e14; }

        .chart-description,
        .section-description {
        font-size: 13px;
        color: #555;
        margin: 8px 0 12px;
        }
        .chart-description ul,
        .section-description ul {
        padding-left: 18px;
        margin: 0;
        }
        .chart-description li,
        .section-description li {
        margin-bottom: 4px;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-button {
            padding: 8px 15px;
            background-color: #203270;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s;
        }

        .filter-button:hover {
            background-color: #4775B0;
        }

        .mbti-highlight {
            color: #203270;
            font-weight: bold;
        }

        .chart-title {
            text-align: center;
            font-size: 14px;
            margin-bottom: 10px;
            color: #555;
        }

        /* MBTI Visualization Styles */
        .mbti-visualization {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .mbti-type {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            border: 2px solid #8FB9D1;
            font-weight: bold;
            position: relative;
            font-size: 14px;
        }

        .mbti-type.your-type {
            border: 3px solid #203270;
            background-color: #e8f4ff;
        }

        .count-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #203270;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .tab {
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background-color: #203270;
            color: white;
            border-color: #203270;
        }

        /* Add space between different sections */
        section {
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Header Section -->
        <section class="header-section">
            <div class="header-title">MBTI Perception Analysis</div>
            <div id="mbti-title">Your MBTI Type: Loading...</div>
        </section>

        <!-- Summary Section -->
        <section class="summary-section">
            <div class="summary-title">Loading data...</div>
            <!-- <ul class="summary-list">
                <li>Loading...</li>
            </ul> -->
        </section>

        <!-- Visualization Section -->
        <section class="visualization-section">
            <div class="chart-container">
                <div class="chart-title">MBTI Type Distribution</div>
                <div class="chart-description">
                    <ul>
                      <li>Each circle is one MBTI type.</li>
                      <li>Orange letters mark letters that differ from your type.</li>
                      <li>The small number shows how many people saw you as that type.</li>
                    </ul>
                  </div>
                <div class="mbti-visualization" id="mbtiVisualization">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Overall Trait Perception</div>
                <div class="chart-description">
                    <ul>
                      <li>Each bar shows how others perceived you on that dimension.</li>
                      <li>Blue (left) = % who saw you matches how you see yourself.</li>
                      <li>Gray (right) = % who saw differs from your own.</li>
                      <li>End letters (I/E, N/S, F/T, J/P) mark the two trait poles.</li>
                    </ul>
                  </div>
                <ul class="summary-list">
                    <li>Loading...</li>
                </ul>
            </div>
        </section>
        <!-- relationshipType">Relationship</button>
        <button class="filter-button" data-filter="sinceWhen">Know time</button>
        <button class="filter-button" data-filter="intimacyGraph">Familiarity</button>
        <button class="filter-button" data-filter="interactionPlace -->
        <!-- Relationship Section -->
         
        <section class="relationship-section">
            <div class="relationship-title">Perception by Relationship Type</div>
            <div class="section-description">
                <ul>
                  <li>Each card is one relationship group (e.g., Friend, Family).</li>
                  <li>Badges show the main letter and percentage for each trait.</li>
                  <li>Badge colors: blue = I/E, green = N/S, purple = F/T, orange = J/P.</li>
                </ul>
              </div>
            <ul class="relationship-list" id="relationshipTypeSection"></ul>
        </section>
        <section class="relationship-section">
            <div class="relationship-title">Perception by Know Time</div>
            <ul class="relationship-list" id="sinceWhenSection"></ul>
        </section>
        <section class="relationship-section">
            <div class="relationship-title">Perception by Familiarity</div>
            <ul class="relationship-list" id="intimacyGraphSection"></ul>
        </section>
        <section class="relationship-section">
            <div class="relationship-title">Perception by Interaction Place</div>
            <ul class="relationship-list" id="interactionPlaceSection"></ul>
        </section>
        
    </div>
</body>
</html>
<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Filter View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvc9C5PuDqrI26jrmsg5b1PVOW6_k43W4",
            authDomain: "mbti-kale.firebaseapp.com",
            databaseURL: "https://mbti-kale-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mbti-kale",
            storageBucket: "mbti-kale.firebasestorage.app",
            messagingSenderId: "756176954275",
            appId: "1:756176954275:web:7581e5e485e426b33ff016",
            measurementId: "G-B6F0F4JZ7E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("name");
        const filterType = urlParams.get("filter") || "relationshipType";
        const MyMBTI = urlParams.get("mbti") || "ENFP";
        document.getElementById("mbti-title").innerHTML = `Your Type: <span class="mbti-highlight">${MyMBTI}</span>`;
        let allData = [];

        document.addEventListener('DOMContentLoaded', async function() {
            await fetchData();
            processData();
        });

        async function fetchData() {
            try {
                const dbRef = ref(database, "responses");
                const q = query(dbRef, orderByChild("username"), equalTo(username));
                const snapshot = await get(q);
                allData = [];

                if (!snapshot.exists()) {
                    console.log("No data found for this username");
                    document.querySelector(".summary-title").innerHTML = "No data found for this username";
                    return;
                }
                
                snapshot.forEach(child => {
                    const d = child.val();
                    if (d.ie && d.ns && d.ft && d.jp) {
                        const mbtiType = getMBTIFromTraits(d.ie, d.ns, d.ft, d.jp);
                        allData.push({
                            email: d.email,
                            ie: d.ie,
                            ns: d.ns,
                            ft: d.ft,
                            jp: d.jp,
                            mbtiType: mbtiType,
                            familiarity: parseInt(d.intimacyGraphReverse) || 1,
                            intimacy: parseInt(d.intimacyGraph) || 1,
                            relationshipType: d.relationshipType || "Unknown",
                            sinceWhen: d.sinceWhen || "Unknown",
                            interactionPlace: d.interactionPlace || "Unknown",
                            filterValue: d[filterType] || "Unknown"
                        });
                    }
                });
                
                console.log("Fetched data:", allData);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.querySelector(".summary-title").innerHTML = "Error fetching data: " + error.message;
            }
        }

        function getMBTIFromTraits(ie, ns, ft, jp) {
            return (ie < 2 ? "I" : "E") + 
                   (ns < 0 ? "N" : "S") + 
                   (ft < 0 ? "F" : "T") + 
                   (jp < 0 ? "J" : "P");
        }

        function processData() {
            if (allData.length === 0) return;
            
            // Calculate MBTI type distribution
            const mbtiCounts = {};
            allData.forEach(person => {
                const type = person.mbtiType;
                mbtiCounts[type] = (mbtiCounts[type] || 0) + 1;
            });
            
            // Calculate trait statistics
            let eCount = 0, sCount = 0, fCount = 0, jCount = 0;
            allData.forEach(person => {
                if (person.ie >= 0) eCount++;
                if (person.ns >= 0) sCount++;
                if (person.ft >= 0) fCount++;
                if (person.jp >= 0) jCount++;
            });
            
            // Find most common mistype
            const mistypes = {};
            allData.forEach(person => {
                if (person.mbtiType !== MyMBTI) {
                    mistypes[person.mbtiType] = (mistypes[person.mbtiType] || 0) + 1;
                }
            });
            
            const mostCommonMistype = Object.keys(mistypes).reduce((a, b) => 
                mistypes[a] > mistypes[b] ? a : b, Object.keys(mistypes)[0]) || "None";
            
            // Calculate average traits for comparison chart
            let avgIE = 0, avgNS = 0, avgFT = 0, avgJP = 0;
            allData.forEach(person => {
                avgIE += person.ie;
                avgNS += person.ns;
                avgFT += person.ft;
                avgJP += person.jp;
            });
            
            avgIE /= allData.length;
            avgNS /= allData.length;
            avgFT /= allData.length;
            avgJP /= allData.length;
            
            // Calculate perception by relationship
            const relationshipPerception = {};
            allData.forEach(person => {
                const rel = person.relationshipType;
                if (!relationshipPerception[rel]) {
                    relationshipPerception[rel] = {
                        types: {},
                        count: 0
                    };
                }
                relationshipPerception[rel].count++;
                relationshipPerception[rel].types[person.mbtiType] = 
                    (relationshipPerception[rel].types[person.mbtiType] || 0) + 1;
            });
            
            // Update UI
            updateSummary(allData.length, allData.filter(p => p.mbtiType !== MyMBTI).length, 
                          mostCommonMistype, eCount, sCount, fCount, jCount);
            
            drawMBTIVisualization(mbtiCounts);
            drawTraitComparisonChart(avgIE, avgNS, avgFT, avgJP);
            updateRelationshipSection(relationshipPerception);
        }

        function updateSummary(totalCount, mistypeCount, mostCommonMistype, eCount, sCount, fCount, jCount) {
            document.querySelector(".summary-title").innerHTML = 
                `Among <span class="mbti-highlight">${totalCount}</span> people, 
                <span class="mbti-highlight">${mistypeCount}</span> people perceive you 
                <span class="mbti-highlight">not your type</span>, 
                the most common mistype is <span class="mbti-highlight">${mostCommonMistype}</span>.`;
            
            const summaryList = document.querySelector(".summary-list");
            summaryList.innerHTML = `
                <li><span class="mbti-highlight">${eCount}</span> people think you are an <span class="mbti-highlight">E</span></li>
                <li><span class="mbti-highlight">${sCount}</span> people think you are an <span class="mbti-highlight">S</span></li>
                <li><span class="mbti-highlight">${fCount}</span> people think you are an <span class="mbti-highlight">F</span></li>
                <li><span class="mbti-highlight">${jCount}</span> people think you are a <span class="mbti-highlight">J</span></li>
            `;
        }

        function drawMBTIVisualization(mbtiCounts) {
            const vizContainer = document.getElementById('mbtiVisualization');
            vizContainer.innerHTML = '';
            
            Object.keys(mbtiCounts).forEach(type => {
                const typeElem = document.createElement('div');
                typeElem.className = 'mbti-type';
                if (type === MyMBTI) {
                    typeElem.classList.add('your-type');
                }
                typeElem.innerText = type;
                
                // Add a count indicator
                const count = document.createElement('span');
                count.className = 'count-badge';
                count.innerText = mbtiCounts[type];
                typeElem.appendChild(count);
                
                vizContainer.appendChild(typeElem);
            });
        }

        function drawTraitComparisonChart(avgIE, avgNS, avgFT, avgJP) {
            // Parse MyMBTI to get numerical values for comparison
            const myTraits = {
                IE: MyMBTI.includes('I') ? -2 : 2,  // Simplified scale for visualization
                NS: MyMBTI.includes('N') ? -2 : 2,
                FT: MyMBTI.includes('F') ? -2 : 2,
                JP: MyMBTI.includes('J') ? -2 : 2
            };
            
            // Scale the averages for better visualization
            const scaledAvgIE = avgIE * 2;  // Scale to similar range as myTraits
            const scaledAvgNS = avgNS * 2;
            const scaledAvgFT = avgFT * 2;
            const scaledAvgJP = avgJP * 2;
            
            const ctx = document.getElementById('traitChart').getContext('2d');
            if (window.traitChart) {
                window.traitChart.destroy();
            }
            
            window.traitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['I/E', 'N/S', 'F/T', 'J/P'],
                    datasets: [
                        {
                            label: 'Your Type',
                            data: [myTraits.IE, myTraits.NS, myTraits.FT, myTraits.JP],
                            backgroundColor: '#203270',
                        },
                        {
                            label: 'Others Perception',
                            data: [scaledAvgIE, scaledAvgNS, scaledAvgFT, scaledAvgJP],
                            backgroundColor: '#e995b8',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: -4,
                            max: 4,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    if (value === -4) return 'Strong I/N/F/J';
                                    if (value === 4) return 'Strong E/S/T/P';
                                    if (value === 0) return 'Neutral';
                                    return '';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateRelationshipSection(relationshipPerception) {
            const relationshipList = document.querySelector(".relationship-list");
            relationshipList.innerHTML = '';
            
            Object.keys(relationshipPerception).forEach(relType => {
                if (relType === "Unknown") return;
                
                const relData = relationshipPerception[relType];
                // Find most common MBTI type for this relationship
                const mostCommonType = Object.keys(relData.types).reduce((a, b) => 
                    relData.types[a] > relData.types[b] ? a : b, Object.keys(relData.types)[0]);
                
                const li = document.createElement('li');
                li.innerHTML = `<span class="mbti-highlight">${relType}</span> perceive you as <span class="mbti-highlight">${mostCommonType}</span>`;
                relationshipList.appendChild(li);
            });
            
            setupFilterButtons();
        }

        function setupFilterButtons() {
            document.querySelectorAll(".filter-button").forEach(btn => {
                btn.addEventListener("click", () => {
                    const filterName = btn.dataset.filter;
                    if (filterName) {
                        window.location.href = `?name=${username}&mbti=${MyMBTI}&filter=${filterName}`;
                    }
                });
            });
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f8fb;
            color: #333;
            margin: 0;
            padding: 30px;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .header-section {
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid #eaeaea;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        #mbti-title {
            font-size: 18px;
            color: #203270;
        }

        .summary-section {
            text-align: left;
            padding: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .summary-list {
            list-style-type: none;
            padding-left: 20px;
        }

        .summary-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
        }

        .summary-list li::before {
            content: "•";
            margin-right: 10px;
            color: #203270;
        }

        .visualization-section {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .chart-container {
            width: 48%;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }

        .relationship-section {
            text-align: left;
            padding: 20px;
            border-top: 1px solid #eaeaea;
        }

        .relationship-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .relationship-list {
            list-style-type: none;
            padding-left: 20px;
        }

        .relationship-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
        }

        .relationship-list li::before {
            content: "•";
            margin-right: 10px;
            color: #203270;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-button {
            padding: 8px 15px;
            background-color: #203270;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s;
        }

        .filter-button:hover {
            background-color: #4775B0;
        }

        .mbti-highlight {
            color: #203270;
            font-weight: bold;
        }

        .chart-title {
            text-align: center;
            font-size: 14px;
            margin-bottom: 10px;
            color: #555;
        }

        /* MBTI Visualization Styles */
        .mbti-visualization {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .mbti-type {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            border: 2px solid #a6dff2;
            font-weight: bold;
            position: relative;
            font-size: 14px;
        }

        .mbti-type.your-type {
            border: 3px solid #203270;
            background-color: #e8f4ff;
        }

        .count-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #203270;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .tab {
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background-color: #203270;
            color: white;
            border-color: #203270;
        }

        /* Add space between different sections */
        section {
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="main-container">
         Header Section 
        <section class="header-section">
            <div class="header-title">MBTI Perception Analysis</div>
            <div id="mbti-title">Your Type: Loading...</div>
        </section>

         Summary Section 
        <section class="summary-section">
            <div class="summary-title">Loading data...</div>
            <ul class="summary-list">
                <li>Loading...</li>
            </ul>
        </section>

         Visualization Section
        <section class="visualization-section">
            <div class="chart-container">
                <div class="chart-title">MBTI Type Distribution</div>
                <div class="mbti-visualization" id="mbtiVisualization">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Trait Comparison</div>
                <canvas id="traitChart"></canvas>
            </div>
        </section>

         Relationship Section 
        <section class="relationship-section">
            <div class="relationship-title">Perception by Relationship Type</div>
            <ul class="relationship-list">
                <li>Loading relationship data...</li>
            </ul>
            <p>You can explore by the filters below, hover over MBTI types to see more details</p>
            <div class="filter-buttons">
                <button class="filter-button" data-filter="relationshipType">Relationship</button>
                <button class="filter-button" data-filter="sinceWhen">Know time</button>
                <button class="filter-button" data-filter="intimacyGraph">Familiarity</button>
                <button class="filter-button" data-filter="interactionPlace">Interaction Place</button>
            </div>
        </section>
    </div>
</body>

</html> -->
<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Filter View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f8fb;
            color: #333;
            margin: 0;
            padding: 30px;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .summary-section {
            text-align: left;
            padding: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .summary-list {
            list-style-type: none;
            padding-left: 20px;
        }

        .summary-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
        }

        .summary-list li::before {
            content: "•";
            margin-right: 10px;
            color: #203270;
        }

        .visualization-section {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .chart-container {
            width: 48%;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }

        .relationship-section {
            text-align: left;
            padding: 20px;
            border-top: 1px solid #eaeaea;
        }

        .relationship-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-button {
            padding: 8px 15px;
            background-color: #203270;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s;
        }

        .filter-button:hover {
            background-color: #4775B0;
        }

        .mbti-highlight {
            color: #203270;
            font-weight: bold;
        }

        .chart-title {
            text-align: center;
            font-size: 14px;
            margin-bottom: 10px;
            color: #555;
        }

        /* MBTI Visualization Styles */
        .mbti-visualization {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .mbti-type {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            border: 2px solid #a6dff2;
            font-weight: bold;
            position: relative;
        }

        .mbti-type.your-type {
            border: 3px solid #203270;
            background-color: #e8f4ff;
        }

        /* Add space between different sections */
        section {
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="main-container">
         Summary Section -->
        <!-- <section class="summary-section">
            <div class="summary-title">Among <span class="mbti-highlight">10</span> people, <span class="mbti-highlight">x</span> people perceive you <span class="mbti-highlight">not your type</span>, the most common mistype is <span class="mbti-highlight">INTJ</span>.</div>
            <ul class="summary-list">
                <li><span class="mbti-highlight">5</span> people think you are an  <span class="mbti-highlight">E</span> </li>
                <li><span class="mbti-highlight">x</span> people think you are an  <span class="mbti-highlight">S</span> </li>
                <li><span class="mbti-highlight">y</span> people think you are an <span class="mbti-highlight">F</span> </li>
                <li><span class="mbti-highlight">z</span> people think you are an <span class="mbti-highlight">J</span> </li>
            </ul>
        </section>

        Visualization Section 
        <section class="visualization-section">
            <div class="chart-container">
                <div class="chart-title">MBTI Type Distribution</div>
                <div class="mbti-visualization" id="mbtiVisualization"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Trait Comparison</div>
                <canvas id="traitChart"></canvas>
            </div>
        </section>

        Relationship Section 
        <section class="relationship-section">
            <div class="relationship-title">Among all the relationship type,</div>
            <ul class="summary-list">
                <li><span class="mbti-highlight">Family members</span> perceive you as <span class="mbti-highlight">INTP</span>, <span class="mbti-highlight">friends</span> think your are an <span class="mbti-highlight">ISTP</span></li>
                <li>...</li>
            </ul>
            <p>You can explore by the filters below, move your mouse to see the perceiver's information</p>
            <div class="filter-buttons">
                <button class="filter-button">Relationship</button>
                <button class="filter-button">Know time</button>
                <button class="filter-button">Familiarity</button>
                <button class="filter-button">Interaction Place</button>
            </div>
        </section>
    </div>

    <script>
        // Mock MBTI data
        const mbtiTypes = [
            { type: "INFP", count: 2 },
            { type: "INTP", count: 3 },
            { type: "INTJ", count: 2 },
            { type: "INFJ", count: 1 },
            { type: "ISFP", count: 1 },
            { type: "ESTP", count: 1 }
        ];
        
        // Draw MBTI visualization
        const vizContainer = document.getElementById('mbtiVisualization');
        mbtiTypes.forEach(item => {
            const typeElem = document.createElement('div');
            typeElem.className = 'mbti-type';
            if (item.type === 'INTP') {
                typeElem.classList.add('your-type');
            }
            typeElem.innerText = item.type;
            vizContainer.appendChild(typeElem);
        });

        // Draw trait comparison chart
        const ctx = document.getElementById('traitChart').getContext('2d');
        const traitChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['I/E', 'N/S', 'F/T', 'J/P'],
                datasets: [
                    {
                        label: 'Your Type',
                        data: [1, 3, 4, 2],
                        backgroundColor: '#203270',
                    },
                    {
                        label: 'Others Perception',
                        data: [2.4, 3, 4, 3],
                        backgroundColor: '#e995b8',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 4.5,
                        ticks: {
                            stepSize: 0.5
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    </script>
</body>

</html> 
<!-- 

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Filter View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f8fb;
            color: #333;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .main-wrapper {
            display: flex;
            width: 80%;
            flex-direction: column;
            align-items: center;
        }

        .dimension-tabs {
            margin: 20px 0;
        }

        .tab {
            padding: 10px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #203270, #FFD4EA);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        .tab.active {
            box-shadow: 0 0 10px #e995b8;
        }

        .chart-container {
            width: 70%;
            margin: 0 auto;
            background: linear-gradient(to bottom right, #ffffff, #f0f4f9);
            border-radius: 16px;
            padding: 25px 30px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        #legend-container {
            text-align: left;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .tooltip-dot {
            position: relative;
        }

        .tooltip-dot:hover::after {
            content: attr(data-tooltip);
            width: 200px;
            white-space: pre-line;
            position: absolute;
            top: -50px;
            left: 0;
            background: white;
            border: 1px solid #ccc;
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            font-size: 13px;
            color: #333;
            z-index: 10;
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <h2 id="mbti-title">MBTI Filter View</h2>
        <div class="chart-container">
            <div id="legend-container"></div>
            <div id="counts-container"></div>
            <div id="mbtiFilterTableContainer"></div>
        </div>
        <div class="dimension-tabs">
            <button class="tab active" data-dimension="IE">I/E</button>
            <button class="tab" data-dimension="NS">N/S</button>
            <button class="tab" data-dimension="FT">F/T</button>
            <button class="tab" data-dimension="JP">J/P</button>
            <button class="tab" data-dimension="ALL">ALL</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvc9C5PuDqrI26jrmsg5b1PVOW6_k43W4",
            authDomain: "mbti-kale.firebaseapp.com",
            databaseURL: "https://mbti-kale-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mbti-kale",
            storageBucket: "mbti-kale.firebasestorage.app",
            messagingSenderId: "756176954275",
            appId: "1:756176954275:web:7581e5e485e426b33ff016",
            measurementId: "G-B6F0F4JZ7E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("name");
        const filterType = urlParams.get("filter");
        const MyMBTI = urlParams.get("mbti");

        let allData = [];

        const traitColors = {
            IE: { I: '#01847F', E: '#F9D2E4' },
            NS: { N: '#002FA7', S: '#FFE76F' },
            FT: { F: '#FF770F', T: '#000026' },
            JP: { J: '#6B946A', P: '#DDD23B' }
        };

        const coloredMBTI = MyMBTI.split("").map(char => `<span style="color:${getColorForLetter(char)}">${char}</span>`).join("");
        document.getElementById("mbti-title").innerHTML = `<span style="color:#555">Your Type: </span>${coloredMBTI}`;

        document.querySelectorAll(".tab").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                const dimension = btn.dataset.dimension;
                drawChart(dimension);
            });
        });

        function getColorForLetter(letter) {
            return traitColors.IE[letter] || traitColors.NS[letter] || traitColors.FT[letter] || traitColors.JP[letter] || '#999';
        }

        async function fetchData() {
            const dbRef = ref(database, "responses");
            const q = query(dbRef, orderByChild("username"), equalTo(username));
            const snapshot = await get(q);
            allData = [];

            if (!snapshot.exists()) return;
            snapshot.forEach(child => {
                const d = child.val();
                if (d.ie && d.ns && d.ft && d.jp) {
                    allData.push({
                        email: d.email,
                        ie: d.ie,
                        ns: d.ns,
                        ft: d.ft,
                        jp: d.jp,
                        familiarity2: parseInt(d.intimacyGraphReverse) || 1,
                        intimacyGraph: parseInt(d.intimacyGraph) || 1,
                        relationshipType: d.relationshipType,
                        sinceWhen: d.sinceWhen,
                        interactionPlace: d.interactionPlace,
                        filterValue: d[filterType] || " "
                    });
                }
            });
            drawChart("IE");
        }

        function drawChart(dimension) {
            const container = document.getElementById("mbtiFilterTableContainer");
            container.innerHTML = "";

            if (dimension === "ALL") {
                const myMBTI = MyMBTI.toUpperCase();
                const centerX = 300;
                const centerY = 300;

                const colorMatch = "#333";  // 蓝绿色匹配色
                const colorDiff = "#ff6b81";   // 不一致的维度色
                const outerColors = ["#a6dff2", "#3eb5e1", "#1a79db", "#0e4e90", "#05465e"]; // 多种 pastel 外圈色

                const typeMap = {};
                allData.forEach(d => {
                    const type = `${d.ie[0]}${d.ns[0]}${d.ft[0]}${d.jp[0]}`.toUpperCase();
                    if (!typeMap[type]) {
                        typeMap[type] = { count: 0, emails: [], diff: 0, names: [] };
                    }
                    typeMap[type].count++;
                    typeMap[type].emails.push(d.email);
                    if (filterType == "ALL") {
                        typeMap[type].names.push(`Name : ${d.email}\n Your Familiarity to him/her : ${d.familiarity2}\n His/her familariyty to you: ${d.intimacyGraph}\n relationship type: ${d.relationshipType}\n Known years: ${d.sinceWhen}\n Interaction place: ${d.interactionPlace}\n`);
                    }
                    else if (filterType == "intimacyGraph") {
                        typeMap[type].names.push(`Name : ${d.email}\n Your Familiarity to him/her: ${d.familiarity2}\n His/her familariyty to you: ${d[filterType]}`);
                    }
                    else {
                        typeMap[type].names.push(`Name : ${d.email}\n Your Familiarity to him/her: ${d.familiarity2}\n ${filterType}: ${d[filterType]}`);
                    }

                    let diff = 0;
                    for (let i = 0; i < 4; i++) {
                        if (type[i] !== myMBTI[i]) diff++;
                    }
                    typeMap[type].diff = diff;
                });

                const canvas = document.createElement("canvas");
                canvas.width = 600;
                canvas.height = 600;
                canvas.style.transition = "opacity 0.6s ease-in-out";
                canvas.style.opacity = 0;
                container.appendChild(canvas);
                const ctx = canvas.getContext("2d");

                const sortedEntries = Object.entries(typeMap).sort((a, b) => a[1].diff - b[1].diff);
                const points = sortedEntries.map(([type, data], index) => {
                    const angle = (index / sortedEntries.length) * 2 * Math.PI;
                    const distance = 80 + data.diff * 40;
                    return {
                        x: centerX + Math.cos(angle) * distance,
                        y: centerY + Math.sin(angle) * distance,
                        type,
                        emails: data.names.join("\n"),
                        diff: data.diff,
                        colorIndex: data.diff % outerColors.length
                    };
                });

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let i = 0;
                function drawNext() {
                    if (i >= points.length) return;
                    const p = points[i];

                    // 背景圈
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 38, 0, 2 * Math.PI);
                    ctx.fillStyle = "#ffffff";
                    ctx.fill();
                    ctx.strokeStyle = outerColors[p.colorIndex];
                    ctx.lineWidth = 4;
                    ctx.shadowColor = "rgba(0, 0, 0, 0.15)";
                    ctx.shadowBlur = 10;
                    ctx.stroke();
                    ctx.shadowBlur = 0;

                    // 字母着色
                    for (let j = 0; j < 4; j++) {
                        ctx.fillStyle = p.type[j] !== myMBTI[j] ? colorDiff : colorMatch;
                        ctx.font = "bold 15px Poppins";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText(p.type[j], p.x - 18 + j * 12, p.y);
                    }

                    // diff 值
                    ctx.fillStyle = "#888";
                    ctx.font = "12px Poppins";
                    ctx.fillText(`${p.diff} diff`, p.x, p.y + 26);

                    i++;
                    setTimeout(drawNext, 200);
                }

                drawNext();
                setTimeout(() => {
                    canvas.style.opacity = 1;
                }, 200);

                // 中心圆圈
                ctx.beginPath();
                ctx.arc(centerX, centerY, 50, 0, 2 * Math.PI);
                ctx.fillStyle = "#fff";
                ctx.fill();
                ctx.strokeStyle = "#a6dff2";
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.fillStyle = "#a6dff2";
                ctx.font = "bold 25px Poppins";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(myMBTI, centerX, centerY);

                // Tooltip
                const tooltip = document.createElement("div");
                Object.assign(tooltip.style, {
                    position: "absolute",
                    padding: "10px 14px",
                    background: "rgba(255,255,255,0.95)",
                    border: "1px solid #ccc",
                    borderRadius: "8px",
                    boxShadow: "0 4px 10px rgba(0,0,0,0.15)",
                    fontSize: "13px",
                    fontFamily: "Poppins, sans-serif",
                    color: "#222",
                    whiteSpace: "pre-line",
                    display: "none",
                    pointerEvents: "none",
                    zIndex: 1000
                });
                document.body.appendChild(tooltip);

                canvas.addEventListener("mousemove", e => {
                    const rect = canvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;

                    let found = false;
                    for (const pt of points) {
                        if (Math.hypot(mx - pt.x, my - pt.y) <= 38) {
                            tooltip.textContent = pt.emails;
                            tooltip.style.left = `${e.pageX + 12}px`;
                            tooltip.style.top = `${e.pageY + 12}px`;
                            tooltip.style.display = "block";
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        tooltip.style.display = "none";
                    }
                });

                canvas.addEventListener("mouseleave", () => {
                    tooltip.style.display = "none";
                });

                return;
            }


            const values = [...new Set(allData.map(d => d.filterValue))];
            const left = dimension[0];
            const right = dimension[1];
            const dimKey = dimension.toLowerCase();

            const table = document.createElement("table");
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            table.style.marginTop = "20px";
            table.style.fontFamily = "Poppins, sans-serif";

            const headerRow = document.createElement("tr");
            headerRow.innerHTML = `<th></th>` + values.map(v => `<th>${v}</th>`).join("");
            table.appendChild(headerRow);

            [left, right].forEach(side => {
                const row = document.createElement("tr");
                const rowHeader = document.createElement("td");
                rowHeader.textContent = side;
                rowHeader.style.fontWeight = "bold";
                row.appendChild(rowHeader);

                values.forEach(val => {
                    const cell = document.createElement("td");
                    cell.style.border = "1px solid #ccc";
                    cell.style.padding = "10px";
                    cell.style.minHeight = "50px";

                    const dots = allData.filter(d => d[dimKey].toUpperCase() === side && d.filterValue === val);
                    dots.forEach(dot => {
                        const div = document.createElement("div");
                        div.className = "tooltip-dot";
                        div.setAttribute("data-tooltip", `Name: ${dot.email}
Your Familiarity: ${dot.familiarity2}`);
                        div.style.width = "10px";
                        div.style.height = "10px";
                        div.style.borderRadius = "50%";
                        div.style.margin = "2px";
                        div.style.backgroundColor = traitColors[dimension][side] || "gray";
                        div.style.display = "inline-block";
                        div.style.cursor = "pointer";
                        cell.appendChild(div);
                    });

                    row.appendChild(cell);
                });

                table.appendChild(row);
            });

            container.appendChild(table);
        }

        fetchData();
    </script>
</body>

</html>

<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Filter View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f8fb;
            color: #333;
            margin: 0;
            padding: 30px;
            text-align: center;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        #all-chart-wrapper {
            margin-top: 50px;
        }

        #allCanvas {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }
        #tooltip {
            position: absolute;
            padding: 10px 14px;
            background: rgba(255,255,255,0.95);
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            font-size: 13px;
            font-family: Poppins, sans-serif;
            color: #222;
            white-space: pre-line;
            display: none;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <h2 id="mbti-title">MBTI Filter View</h2>
        <canvas id="combinedBar" width="900" height="400"></canvas>
        <div id="all-chart-wrapper">
            <canvas id="allCanvas" width="600" height="600"></canvas>
        </div>
        <div id="tooltip"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvc9C5PuDqrI26jrmsg5b1PVOW6_k43W4",
            authDomain: "mbti-kale.firebaseapp.com",
            databaseURL: "https://mbti-kale-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mbti-kale",
            storageBucket: "mbti-kale.firebasestorage.app",
            messagingSenderId: "756176954275",
            appId: "1:756176954275:web:7581e5e485e426b33ff016",
            measurementId: "G-B6F0F4JZ7E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("name");
        const MyMBTI = urlParams.get("mbti").toUpperCase();

        const traitColors = {
            IE: { I: '#01847F', E: '#F9D2E4' },
            NS: { N: '#002FA7', S: '#FFE76F' },
            FT: { F: '#FF770F', T: '#000026' },
            JP: { J: '#6B946A', P: '#DDD23B' }
        };

        let chartData = [];

        async function fetchData() {
            const dbRef = ref(database, "responses");
            const q = query(dbRef, orderByChild("username"), equalTo(username));
            const snapshot = await get(q);

            if (!snapshot.exists()) return;
            snapshot.forEach(child => {
                const d = child.val();
                if (d.ie && d.ns && d.ft && d.jp) {
                    chartData.push({
                        ie: d.ie,
                        ns: d.ns,
                        ft: d.ft,
                        jp: d.jp
                    });
                }
            });

            drawCombinedBarChart(chartData);
            drawAllDiagram(chartData);
        }

        function drawCombinedBarChart(data) {
            const dimLabels = ["I", "E", "", "N", "S", "", "F", "T", "", "J", "P"];
            const dimMap = ["ie", "ie", null, "ns", "ns", null, "ft", "ft", null, "jp", "jp"];
            const counts = dimLabels.map((label, i) => {
                if (label === "") return 0;
                const dim = dimMap[i];
                return data.filter(d => d[dim].toUpperCase() === label).length;
            });

            const colors = dimLabels.map((label, i) => {
                if (label === "") return "#ffffff";
                const dim = dimMap[i].toUpperCase();
                return traitColors[dim][label];
            });

            const ctx = document.getElementById("combinedBar").getContext("2d");
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dimLabels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "Count"
                            }
                        }
                    }
                }
            });
        }

        function drawAllDiagram(data) {
            const canvas = document.getElementById("allCanvas");
            const ctx = canvas.getContext("2d");
            const centerX = 300;
            const centerY = 300;
            const outerColors = ["#a6dff2", "#3eb5e1", "#1a79db", "#0e4e90", "#05465e"];
            const colorMatch = "#333";
            const colorDiff = "#ff6b81";
            const typeMap = {};

            data.forEach(d => {
                const type = `${d.ie[0]}${d.ns[0]}${d.ft[0]}${d.jp[0]}`.toUpperCase();
                if (!typeMap[type]) {
                    typeMap[type] = { count: 0, diff: 0 };
                }
                typeMap[type].count++;
                let diff = 0;
                for (let i = 0; i < 4; i++) {
                    if (type[i] !== MyMBTI[i]) diff++;
                }
                typeMap[type].diff = diff;
            });

            const sortedEntries = Object.entries(typeMap).sort((a, b) => a[1].diff - b[1].diff);
            const points = sortedEntries.map(([type, data], index) => {
                const angle = (index / sortedEntries.length) * 2 * Math.PI;
                const distance = 80 + data.diff * 40;
                return {
                    x: centerX + Math.cos(angle) * distance,
                    y: centerY + Math.sin(angle) * distance,
                    type,
                    diff: data.diff,
                    colorIndex: data.diff % outerColors.length
                };
            });

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            points.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 38, 0, 2 * Math.PI);
                ctx.fillStyle = "#ffffff";
                ctx.fill();
                ctx.strokeStyle = outerColors[p.colorIndex];
                ctx.lineWidth = 4;
                ctx.shadowColor = "rgba(0, 0, 0, 0.15)";
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.shadowBlur = 0;

                for (let j = 0; j < 4; j++) {
                    ctx.fillStyle = p.type[j] !== MyMBTI[j] ? colorDiff : colorMatch;
                    ctx.font = "bold 15px Poppins";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(p.type[j], p.x - 18 + j * 12, p.y);
                }

                ctx.fillStyle = "#888";
                ctx.font = "12px Poppins";
                ctx.fillText(`${p.diff} diff`, p.x, p.y + 26);
            });

            // Center circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, 50, 0, 2 * Math.PI);
            ctx.fillStyle = "#fff";
            ctx.fill();
            ctx.strokeStyle = "#a6dff2";
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = "#a6dff2";
            ctx.font = "bold 25px Poppins";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(MyMBTI, centerX, centerY);
        }

        fetchData();
    </script>
</body>

</html> --> 
