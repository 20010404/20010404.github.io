<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Questionnaire</title>
    <script src="switch_language.js" defer></script>
    <link rel="stylesheet" href="style2.css">
</head>

<body>
    <div class="container">
        <!-- ËØ≠Ë®ÄÂàáÊç¢ -->
        <div class="language-switcher">
            <div class="toggle-container">
                <input type="radio" id="lang-en" name="language" value="en" checked>
                <label for="lang-en">A</label>

                <input type="radio" id="lang-zh" name="language" value="zh">
                <label for="lang-zh">‰∏≠</label>

                <input type="radio" id="lang-ko" name="language" value="ko">
                <label for="lang-ko">Ìïú</label>

                <div class="toggle-slider"></div>
            </div>
        </div>

        <h1 id="form-title">MBTI survey - <span id="username"></span></h1>
        <p id="introduction">
            This is an MBTI perception form, you can answer how you perceive him/her in 4 different aspects according to
            real-life interactions.
        </p>

        <!-- ÈóÆÂç∑Ë°®Âçï -->
        <form id="questionnaire-form" onsubmit="submitQuestionnaire(event)">
            <div class="form-row">
                <label for="email" id="label-email">Your email or your identical nickname:</label>
                <input type="text" id="email" name="email" placeholder="a.com or Bob  " required>
            </div>
            <p>Please choose the graph that best describes your relationship closeness with 
                <span id="username"></span>:
            </p>

            <div class="graph-selection">
                <input type="hidden" id="selectedGraph" name="intimacyGraph" value="">
                <div class="graph-options"></div>
            </div>
            <div class="form-row">
                <label for="ie" id="label-ie">I/E Percentage:</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-ie">I: Introversion, E: Extraversion</span>
                </span>
                <input type="text" id="ie" name="ie" placeholder="e.g., 70%E" required>
            </div>

            <div class="form-row">
                <label for="ns" id="label-ns">N/S Percentage:</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-ns">N: Intuition, S: Sensing</span>
                </span>
                <input type="text" id="ns" name="ns" placeholder="e.g., 60%N" required>
            </div>

            <div class="form-row">
                <label for="ft" id="label-ft">F/T Percentage:</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-ft">F: Feeling, T: Thinking</span>
                </span>
                <input type="text" id="ft" name="ft" placeholder="e.g., 80%T" required>
            </div>

            <div class="form-row">
                <label for="jp" id="label-jp">J/P Percentage:</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-jp">J: Judging, P: Perceiving</span>
                </span>
                <input type="text" id="jp" name="jp" placeholder="e.g., 50%J" required>
            </div>
            <button type="submit" id="submit-button">Submit</button>
        </form>

        <script type="module">
            // È°µÈù¢Âä†ËΩΩÂêéÂàùÂßãÂåñÂÜÖÂÆπ
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
            import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
            document.addEventListener("DOMContentLoaded", async () => {
                console.log("Initializing page...");

                // **üî• Firebase ÈÖçÁΩÆ**
                const firebaseConfig = {
                    apiKey: "AIzaSyCvc9C5PuDqrI26jrmsg5b1PVOW6_k43W4",
                    authDomain: "mbti-kale.firebaseapp.com",
                    databaseURL: "https://mbti-kale-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "mbti-kale",
                    storageBucket: "mbti-kale.firebasestorage.app",
                    messagingSenderId: "756176954275",
                    appId: "1:756176954275:web:7581e5e485e426b33ff016",
                    measurementId: "G-B6F0F4JZ7E"
                };

                // **ÂàùÂßãÂåñ Firebase**
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                const database = getDatabase(app);

                // **üî• Â§ÑÁêÜ URL ÂèÇÊï∞**
                const urlParams = new URLSearchParams(window.location.search);
                const username = urlParams.get("username");
                console.log("URL Parameters:", { username });

                if (username) {
                    document.getElementById("username").textContent = username;
                } else {
                    console.error("No username found in URL parameters.");
                }
                const graphOptionsContainer = document.querySelector(".graph-options");
                const selectedGraphInput = document.getElementById("selectedGraph");

                const positions = [
                    { cx1: 30, cx2: 70 }, // 1
                    { cx1: 40, cx2: 60 }, // 2
                    { cx1: 38, cx2: 62 }, // 3
                    { cx1: 35, cx2: 65 }, // 4
                    { cx1: 33, cx2: 67 }, // 5
                    { cx1: 32, cx2: 68 }, // 6
                    { cx1: 30, cx2: 70 }  // 7
                ];

                for (let i = 0; i < 7; i++) {
                    const graphContainer = document.createElement("div");
                    graphContainer.classList.add("graph");
                    graphContainer.dataset.value = i + 1;
                    graphContainer.innerHTML = createRelationshipGraph(positions[i].cx1, positions[i].cx2, "You", username);

                    graphContainer.addEventListener("click", () => {
                        document.querySelectorAll(".graph").forEach(g => g.classList.remove("selected"));
                        graphContainer.classList.add("selected");
                        selectedGraphInput.value = graphContainer.dataset.value;
                    });

                    graphOptionsContainer.appendChild(graphContainer);
                }

                function createRelationshipGraph(cx1, cx2, selfText, otherText) {
                    return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="gradient-border" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#2489b8; stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#e995b8; stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle cx="${cx1}" cy="50" r="20" stroke="black" stroke-width="2" fill="none"/>
                                <circle cx="${cx2}" cy="50" r="20" stroke="black" stroke-width="2" fill="none"/>
                                <text x="${cx1 - 10}" y="50" font-size="8">${selfText}</text>
                                <text x="${cx2 - 10}" y="50" font-size="8">${otherText}</text>
                            </svg>`;
                }
                // **üî• ÁªëÂÆöË°®ÂçïÊèê‰∫§‰∫ã‰ª∂**
                document.getElementById("questionnaire-form").addEventListener("submit", async (event) => {
                    event.preventDefault();

                    // **Êî∂ÈõÜÁî®Êà∑ËæìÂÖ•ÁöÑÊï∞ÊçÆ**
                    const data = {
                        username: username,
                        email: document.getElementById("email").value,
                        ie: document.getElementById("ie").value,
                        ns: document.getElementById("ns").value,
                        ft: document.getElementById("ft").value,
                        jp: document.getElementById("jp").value,
                        intimacyGraph :document.getElementById("selectedGraph").value,
                        timestamp: new Date().toISOString()
                    };

                    console.log("Collected Data:", data);

                    try {
                        // **üî• Â≠òÂÖ• Firebase**
                        const dbRef = ref(database, "responses");
                        await push(dbRef, data);
                        console.log("Data saved successfully to Firebase:", data);
                        alert("Data has been successfully submitted to firebase!");
                    } catch (error) {
                        console.error("Firebase Error:", error);
                        alert("Error submitting data. Please try again.");
                    }
                });

                // **üî• ËØ≠Ë®ÄÂàáÊç¢ - ÁªëÂÆö‰∫ã‰ª∂**
                document.querySelectorAll(".toggle-container input").forEach((radio) => {
                    radio.addEventListener("change", (event) => {
                        const selectedLang = event.target.value;
                        changeLanguage(selectedLang);
                    });
                });

                // **üî• È°µÈù¢Âä†ËΩΩÊó∂ÔºåÂ∫îÁî®‰∏äÊ¨°ÈÄâÊã©ÁöÑËØ≠Ë®Ä**
                const savedLang = localStorage.getItem("selectedLanguage") || "en"; // ÈªòËÆ§ English
                document.getElementById(`lang-${savedLang}`).checked = true;
                changeLanguage(savedLang);
            });
        </script>
</body>

</html>