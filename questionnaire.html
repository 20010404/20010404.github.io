<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Questionnaire</title>
    <script src="switch_language.js" defer></script>
    <link rel="stylesheet" href="style2.css">
</head>

<body>
    <div class="container">
        <!-- è¯­è¨€åˆ‡æ¢ -->
        <div class="language-switcher">
            <div class="toggle-container">
                <input type="radio" id="lang-en" name="language" value="en" checked>
                <label for="lang-en">A</label>

                <input type="radio" id="lang-zh" name="language" value="zh">
                <label for="lang-zh">ä¸­</label>

                <input type="radio" id="lang-ko" name="language" value="ko">
                <label for="lang-ko">í•œ</label>

                <div class="toggle-slider"></div>
            </div>
        </div>

        <h1 id="form-title"> <span id="username"></span>'s MBTI survey from</h1>
        <p id="introduction">
            This is an MBTI perception form, you can answer how you perceive <span id="username"></span> MBTI
            according to recent
            real-life interactions.
        </p>

        <!-- é—®å·è¡¨å• -->
        <form id="questionnaire-form" onsubmit="submitQuestionnaire(event)">
            <div class="form-row">
                <label for="email" id="label-email">Your given name</label>
            </div>
            <div class="form-row"> <input type="text" id="email" name="email" placeholder="Bob/ì¤€ì˜/æ˜Šå¤©" required></div>
            <div class="form-row">
                <lable id="relation">How much do you think you know him/her? Please choose the graph that best describes
                    your familiarity with <span id="username"></span></lable>
            </div>
            <div class="graph-selection">
                <input type="hidden" id="selectedGraph" name="intimacyGraph" value="">
                <div class="graph-options"></div>
            </div>
            <div class="form-row">
                <label for="ie" id="label-ie">I/E Type</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-ie">Introverts(I) are energized by spending quiet time alone
                        or with a small group. They tend to be more reserved and thoughtful.
                        Extraverts(E) are energized by spending time with people and in busy, active surroundings. They
                        tend to be more expressive and outspoken.</span>
                </span>

            </div>
            <div class="form-row"><input type="text" id="ie" name="ie" placeholder="e.g., E" required></div>
            <div class="form-row">
                <label for="ns" id="label-ns">N/S Type</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-ns">N: Intuition, S: Sensing</span>
                </span>
            </div>
            <div class="form-row"> <input type="text" id="ns" name="ns" placeholder="e.g., N" required> </div>

            <div class="form-row">
                <label for="ft" id="label-ft"> F/T Type</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-ft">F: Feeling, T: Thinking</span>
                </span>
            </div>
            <div class="form-row"> <input type="text" id="ft" name="ft" placeholder="e.g., F" required></div>
            <div class="form-row">
                <label for="jp" id="label-jp">J/P Type</label>
                <span class="tooltip">?
                    <span class="tooltip-text" id="tooltip-jp">J: Judging, P: Perceiving</span>
                </span>
            </div>
            <div class="form-row"><input type="text" id="jp" name="jp" placeholder="e.g., J" required></div>
            <button type="submit" id="submit-button">Submit</button>
        </form>

        <script type="module">
            

            // é¡µé¢åŠ è½½ååˆå§‹åŒ–å†…å®¹
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
            import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
            document.addEventListener("DOMContentLoaded", async () => {
                console.log("Initializing page...");
                const graphContainer = document.getElementById("graph-options");
           
                // **ğŸ”¥ Firebase é…ç½®**
                const firebaseConfig = {
                    apiKey: "AIzaSyCvc9C5PuDqrI26jrmsg5b1PVOW6_k43W4",
                    authDomain: "mbti-kale.firebaseapp.com",
                    databaseURL: "https://mbti-kale-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "mbti-kale",
                    storageBucket: "mbti-kale.firebasestorage.app",
                    messagingSenderId: "756176954275",
                    appId: "1:756176954275:web:7581e5e485e426b33ff016",
                    measurementId: "G-B6F0F4JZ7E"
                };

                // **åˆå§‹åŒ– Firebase**
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                const database = getDatabase(app);

                // **ğŸ”¥ å¤„ç† URL å‚æ•°**
                const urlParams = new URLSearchParams(window.location.search);
                const username = urlParams.get("username");
                console.log("URL Parameters:", { username });

                if (username) {
                    document.getElementById("username").textContent = username;
                } else {
                    console.error("No username found in URL parameters.");
                }
                const graphOptionsContainer = document.querySelector(".graph-options");
                const selectedGraphInput = document.getElementById("selectedGraph");

                const positions = [
                    { cx1: 40, cx2: 120 }, // 1
                    { cx1: 40, cx2: 110 }, // 2
                    { cx1: 40, cx2: 100 }, // 3
                    { cx1: 40, cx2: 90 }, // 4
                    { cx1: 40, cx2: 80 }, // 5
                    { cx1: 40, cx2: 70 }, // 6
                    { cx1: 40, cx2: 60 }  // 7
                ];

                for (let i = 0; i < 7; i++) {
                    const graphContainer = document.createElement("div");
                    graphContainer.classList.add("graph");
                    graphContainer.dataset.value = i + 1;
                    graphContainer.innerHTML = createRelationshipGraph(positions[i].cx1, positions[i].cx2, "You", username);
                    graphContainer.addEventListener("click", () => {
                        document.querySelectorAll(".graph").forEach(g => g.classList.remove("selected"));
                        graphContainer.classList.add("selected");
                        selectedGraphInput.value = graphContainer.dataset.value;
                    });

                    graphOptionsContainer.appendChild(graphContainer);
                }

                function createRelationshipGraph(cx1, cx2, selfText, otherText) {
                    return `<svg viewBox="0 0 160 80" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="gradient-border" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#2489b8; stop-opacity:1" />
                        <stop offset="100%" style="stop-color   :#e995b8; stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="${cx1}" cy="40" r="40" stroke="black" stroke-width="1" fill="none"/>
                <circle cx="${cx2}" cy="40" r="40" stroke="black" stroke-width="1" fill="none"/>
                <text x="${cx1 - 15}" y="40" font-size="10">${selfText}</text>
                <text x="${cx2 - 15}" y="40" font-size="10">${otherText}</text>
            </svg>`;
                }
                // åœ¨è¡¨å•æäº¤æˆåŠŸåè°ƒç”¨æ­¤å‡½æ•°
                function triggerFireworks() {
                    // åˆ›å»ºcanvaså…ƒç´ 
                    const canvas = document.createElement('canvas');
                    canvas.id = 'fireworks-canvas';
                    canvas.style.position = 'fixed';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.pointerEvents = 'none';
                    canvas.style.zIndex = '9999';
                    document.body.appendChild(canvas);

                    let ctx, w, h, particles = [];
                    let xPoint, yPoint;

                    // åˆå§‹åŒ–canvas
                    function initCanvas() {
                        ctx = canvas.getContext("2d");
                        resizeCanvas();
                        window.requestAnimationFrame(updateWorld);
                    }

                    // è°ƒæ•´canvaså¤§å°
                    function resizeCanvas() {
                        w = canvas.width = window.innerWidth;
                        h = canvas.height = window.innerHeight;
                    }

                    // è¯·æ±‚åŠ¨ç”»å¸§å…¼å®¹å¤„ç†
                    window.requestAnimationFrame =
                        window.requestAnimationFrame ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        window.oRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function (callback) {
                            window.setTimeout(callback, 1000 / 60);
                        };

                    // æ›´æ–°ä¸–ç•ŒçŠ¶æ€
                    function updateWorld() {
                        update();
                        paint();
                        // å¦‚æœè¿˜æœ‰ç²’å­ï¼Œç»§ç»­åŠ¨ç”»
                        if (particles.length > 0) {
                            window.requestAnimationFrame(updateWorld);
                        } else {
                            // çƒŸèŠ±ç»“æŸåç§»é™¤canvas
                            setTimeout(() => {
                                document.body.removeChild(canvas);
                            }, 1000);
                        }
                    }

                    // æ›´æ–°ç²’å­
                    function update() {
                        // åˆ›å»ºå¤šä¸ªçƒŸèŠ±ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´åˆ›å»ºä¸€ä¸ª
                        if (fireworksCount < maxFireworks) {
                            createFirework();
                            fireworksCount++;
                            setTimeout(() => {
                                if (particles.length < 1000) {
                                    createFirework();
                                    fireworksCount++;
                                }
                            }, 300);
                        }

                        // æ›´æ–°ç²’å­çŠ¶æ€
                        let alive = [];
                        for (let i = 0; i < particles.length; i++) {
                            if (particles[i].move()) {
                                alive.push(particles[i]);
                            }
                        }
                        particles = alive;
                    }

                    // ç»˜åˆ¶ç²’å­
                    // function paint() {
                    //     // åŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼Œå½¢æˆæ‹–å°¾æ•ˆæœ
                    //     ctx.globalCompositeOperation = 'source-over';
                    //     ctx.fillStyle = "rgba(0,0,0,0.1)";
                    //     ctx.fillRect(0, 0, w, h);

                    //     // ä½¿ç”¨"lighter"æ··åˆæ¨¡å¼ä½¿é‡å çš„ç²’å­æ›´äº®
                    //     ctx.globalCompositeOperation = 'lighter';
                    //     for (let i = 0; i < particles.length; i++) {
                    //         particles[i].draw(ctx);
                    //     }
                    // }
                    function paint() {
                        // æ¸…é™¤ç”»å¸ƒä½†ä¿æŒé€æ˜èƒŒæ™¯
                        ctx.clearRect(0, 0, w, h);

                        // ä½¿ç”¨"lighter"æ··åˆæ¨¡å¼ä½¿é‡å çš„ç²’å­æ›´äº®
                        ctx.globalCompositeOperation = 'lighter';
                        for (let i = 0; i < particles.length; i++) {
                            particles[i].draw(ctx);
                        }
                    }

                    // åˆ›å»ºä¸€ä¸ªçƒŸèŠ±
                    function createFirework() {
                        // éšæœºä½ç½®ï¼Œä½†æ›´å€¾å‘äºå±å¹•ä¸­å¤®
                        xPoint = w / 2 + (Math.random() - 0.5) * w * 0.6;
                        yPoint = h / 2 + (Math.random() - 0.5) * h * 0.6;

                        // æ¯ä¸ªçƒŸèŠ±çš„ç²’å­æ•°é‡
                        const nFire = Math.random() * 100 + 100;

                        // éšæœºé¢œè‰²
                        const colors = [
                            "rgb(255, 100, 100)", // çº¢è‰²
                            "rgb(255, 150, 50)",  // æ©™è‰²
                            "rgb(255, 200, 0)",   // é»„è‰²
                            "rgb(100, 255, 100)", // ç»¿è‰²
                            "rgb(50, 150, 255)",  // è“è‰²
                            "rgb(200, 100, 255)"  // ç´«è‰²
                        ];
                        const c = colors[Math.floor(Math.random() * colors.length)];

                        // åˆ›å»ºç²’å­
                        for (let i = 0; i < nFire; i++) {
                            const particle = new Particle();
                            particle.color = c;
                            const vy = Math.sqrt(25 - particle.vx * particle.vx);
                            if (Math.abs(particle.vy) > vy) {
                                particle.vy = particle.vy > 0 ? vy : -vy;
                            }
                            particles.push(particle);
                        }
                    }

                    // ç²’å­ç±»
                    function Particle() {
                        this.w = this.h = Math.random() * 4 + 2;

                        this.x = xPoint - this.w / 2;
                        this.y = yPoint - this.h / 2;

                        // éšæœºé€Ÿåº¦
                        this.vx = (Math.random() - 0.5) * 10;
                        this.vy = (Math.random() - 0.5) * 10;

                        this.alpha = Math.random() * 0.5 + 0.5;

                        this.color;
                    }

                    // ç²’å­æ–¹æ³•
                    Particle.prototype = {
                        gravity: 0.05,
                        move: function () {
                            this.x += this.vx;
                            this.vy += this.gravity;
                            this.y += this.vy;
                            this.alpha -= 0.01;
                            if (this.x <= -this.w || this.x >= w ||
                                this.y >= h ||
                                this.alpha <= 0) {
                                return false;
                            }
                            return true;
                        },
                        draw: function (c) {
                            c.save();
                            c.beginPath();

                            c.translate(this.x + this.w / 2, this.y + this.h / 2);
                            c.arc(0, 0, this.w, 0, Math.PI * 2);
                            c.fillStyle = this.color;
                            c.globalAlpha = this.alpha;

                            c.closePath();
                            c.fill();
                            c.restore();
                        }
                    };

                    // æ§åˆ¶çƒŸèŠ±æ•°é‡
                    let fireworksCount = 0;
                    let maxFireworks = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªçƒŸèŠ±

                    // åˆå§‹åŒ–canvaså¹¶å¼€å§‹åŠ¨ç”»
                    initCanvas();
                }

                // åˆ›å»ºå•ä¸ªçƒŸèŠ±
                function createFirework(container, centerX, centerY, colors) {
                    // ç›´æ¥ä»ä¸­å¿ƒçˆ†ç‚¸ï¼Œä¸éœ€è¦ä¸Šå‡åŠ¨ç”»
                    explode(container, centerX, centerY, colors[Math.floor(Math.random() * colors.length)]);
                }

                // çƒŸèŠ±çˆ†ç‚¸æ•ˆæœ
                function explode(container, x, y, color) {
                    // å¢åŠ ç²’å­æ•°é‡ï¼Œä½¿çƒŸèŠ±çœ‹èµ·æ¥æ›´ä¸°å¯Œ
                    const particles = 60 + Math.floor(Math.random() * 40);

                    for (let i = 0; i < particles; i++) {
                        const particle = document.createElement('div');

                        // åˆ›å»ºæ›´å¤§ã€æ›´äº®çš„ç²’å­ï¼Œæœ‰äº›ç²’å­è¾ƒé•¿ï¼ˆåƒå›¾ç‰‡ä¸­çš„å…‰çº¿æ•ˆæœï¼‰
                        const isLongParticle = Math.random() > 0.7;

                        particle.style.position = 'absolute';
                        particle.style.width = isLongParticle ? '2px' : '3px';
                        particle.style.height = isLongParticle ? '10px' : '3px';
                        particle.style.borderRadius = isLongParticle ? '2px' : '50%';
                        particle.style.backgroundColor = color;
                        particle.style.boxShadow = `0 0 6px 1px ${color}`;
                        particle.style.opacity = '0.9';
                        particle.style.left = `${x}px`;
                        particle.style.top = `${y}px`;

                        if (isLongParticle) {
                            // è®¾ç½®é•¿ç²’å­çš„åˆå§‹æ—‹è½¬è§’åº¦
                            particle.style.transform = 'rotate(0deg)';
                        }

                        container.appendChild(particle);

                        // éšæœºæ–¹å‘ï¼Œä½†ä¿æŒå‡åŒ€åˆ†å¸ƒä»¥å½¢æˆåœ†å½¢çƒŸèŠ±
                        const angle = (i / particles) * Math.PI * 2 + (Math.random() * 0.2 - 0.1);
                        const speed = 2 + Math.random() * 4;
                        const distance = 100 + Math.random() * 150; // æœ€å¤§è·ç¦»

                        // è¿åŠ¨å’Œæ¶ˆå¤±åŠ¨ç”»
                        let start = null;
                        const duration = 1200 + Math.random() * 800;

                        function animateParticle(timestamp) {
                            if (!start) start = timestamp;
                            const progress = (timestamp - start) / duration;

                            if (progress < 1) {
                                // ä½¿ç”¨äºŒæ¬¡æ–¹æ›²çº¿è®©ç²’å­é€Ÿåº¦å…ˆå¿«åæ…¢
                                const currentDistance = distance * (progress < 0.7 ? progress : 0.7 + (progress - 0.7) * 0.3);

                                const newX = x + Math.cos(angle) * currentDistance;
                                const newY = y + Math.sin(angle) * currentDistance;

                                particle.style.left = `${newX}px`;
                                particle.style.top = `${newY}px`;

                                if (isLongParticle) {
                                    // æ—‹è½¬é•¿ç²’å­ï¼Œä½¿å…¶æŒ‡å‘çˆ†ç‚¸ä¸­å¿ƒ
                                    const rotationAngle = Math.atan2(newY - y, newX - x) * (180 / Math.PI);
                                    particle.style.transform = `rotate(${rotationAngle}deg)`;
                                }

                                // é—ªçƒå’Œæ·¡å‡ºæ•ˆæœ
                                particle.style.opacity = Math.sin(progress * Math.PI) * (1 - progress);

                                requestAnimationFrame(animateParticle);
                            } else {
                                container.removeChild(particle);
                            }
                        }

                        requestAnimationFrame(animateParticle);
                    }
                }

                // **ğŸ”¥ ç»‘å®šè¡¨å•æäº¤äº‹ä»¶**

                document.getElementById("questionnaire-form").addEventListener("submit", async (event) => {
                    event.preventDefault();

                    // **æ”¶é›†ç”¨æˆ·è¾“å…¥çš„æ•°æ®**
                    const data = {
                        username: username,
                        email: document.getElementById("email").value,
                        ie: document.getElementById("ie").value,
                        ns: document.getElementById("ns").value,
                        ft: document.getElementById("ft").value,
                        jp: document.getElementById("jp").value,
                        intimacyGraph: document.getElementById("selectedGraph").value,
                        timestamp: new Date().toISOString()
                    };

                    console.log("Collected Data:", data);

                    try {
                        // **ğŸ”¥ å­˜å…¥ Firebase**
                        // **ğŸ”¥ å­˜å…¥ Firebase**
                        const dbRef = ref(database, "responses");
                        await push(dbRef, data);
                        triggerFireworks();
                        // **æ–­å¼€ Firebase è¿æ¥**
                        // firebase.database().goOffline();
                        // **æ˜¾ç¤ºæç¤º**
                        // è‡ªåŠ¨å…³é—­ç½‘é¡µ
                        setTimeout(() => {
                            alert("Thanks for your participation! The page will now close.");
                            window.close();
                        }, 3000);
                    } catch (error) {
                        console.error("Firebase Error:", error);
                        alert("Error submitting data. Please try again.");
                    }
                });

                // **ğŸ”¥ è¯­è¨€åˆ‡æ¢ - ç»‘å®šäº‹ä»¶**
                document.querySelectorAll(".toggle-container input").forEach((radio) => {
                    radio.addEventListener("change", (event) => {
                        const selectedLang = event.target.value;
                        changeLanguage(selectedLang);
                    });
                });

                // **ğŸ”¥ é¡µé¢åŠ è½½æ—¶ï¼Œåº”ç”¨ä¸Šæ¬¡é€‰æ‹©çš„è¯­è¨€**
                const savedLang = localStorage.getItem("selectedLanguage") || "en"; // é»˜è®¤ English
                document.getElementById(`lang-${savedLang}`).checked = true;
                changeLanguage(savedLang);
            });
        </script>
</body>

</html>